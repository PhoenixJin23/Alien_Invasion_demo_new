import pygame
import sys
from settings import Settings#文件名 import 类名
from ship import Ship
from bullet import Bullet
class AlienInvasion:
    """管理游戏资源和循环的类"""

    def __init__(self):
        """初始化游戏并创建游戏资源"""
        pygame.init()#初始化游戏，必不可少#游戏初始化时需要构造实例
        self.settings=Settings()
        #为了能访问Settings类里的资源，设置一个新的属性并把它赋值给类的一个实例
        self.screen=pygame.display.set_mode((self.settings.screen_width,self.settings.screen_height))
        #给类创建一个screen属性，返回一个游戏的展示屏幕，传入的元组可设置窗口的宽和高（单位：像素）
        #让尺寸数据从属性里获取
        pygame.display.set_caption("Alien Invasion")#设置游戏的名字
        #self.bg_color=(138,206,0) #设置背景色：红，绿，蓝，最多255
        self.ship=Ship(self)#创建新属性，把它赋值为飞船的一个实例
        #飞船的构造函数还需要一个游戏实例，所以把当前游戏传进去。当飞船拿到游戏实例后，就将自己绘制到游戏屏幕上
        #需要传入的参数有两个，self代表AlienInvasion本身，作为实参传入ai_game，帮助ship访问AlienInvasion
        self.bullets=pygame.sprite.Group()#创建一个子弹的编组

    
    def run_game(self):#游戏是由run_game这个方法控制的，一旦被调用游戏就会开始运行
        while True:#只要游戏不被手动中断，程序会一直运行，每次循环都会运行以下代码
            self._check_events()
            self.ship.update()#每次循环都让飞船位置更新一下
            self.bullets.update()
            self._update_bullets()
            self._update_screen()


    def _check_events(self):#以下划线开头的方法，有私密性，只能在当前的类使用
        # 监视鼠标和键盘事件
        for event in pygame.event.get():  # pygame.event.get()会返回一切用户事件
            # 每次循环可能同时发生很多事情，用for循环迭代每件事
            if event.type == pygame.QUIT:
                sys.exit()  # 只要事件是退出（用户点窗口的×），就停止程序运行
            elif event.type==pygame.KEYDOWN:#事件类型如果是按下键盘按键
                self._check_keydown_events(event)
            elif event.type==pygame.KEYUP:
                self._check_keyup_events(event)


    def _check_keydown_events(self,event):#只处理按下键盘的方法
        """响应键盘"""
        if event.key == pygame.K_RIGHT:  # 并且按下的键是右键
            # self.ship.rect.x+=1  就把飞船的外接矩形向右移动————这个只能实现单次按右键移动，不能长按右键连续移动
            self.ship.moving_right = True  # 按下右键，moving_right属性为真
        elif event.key == pygame.K_LEFT:
            self.ship.moving_left = True
        elif event.key==pygame.K_q:
            sys.exit()
        elif event.key==pygame.K_SPACE:
            self._fire_bullet()

    def _check_keyup_events(self,event):
        """响应松开"""
        if event.key == pygame.K_RIGHT:
            self.ship.moving_right = False  # 松开右键，moving_right属性为假
        elif event.key == pygame.K_LEFT:
            self.ship.moving_left = False


    def _update_screen(self):
        # 每次循环时都重绘屏幕
        self.screen.fill(self.settings.bg_color)
        self.ship.blitme()
        for bullet in self.bullets.sprites():#遍历编组里的每一个子弹
            bullet.draw_bullet()
        # 让最近绘制的屏幕可见
        pygame.display.flip()
        # 在while循环内，刷新屏幕，重新绘制屏幕上的内容，用新的屏幕内容代替旧的

    def _update_bullets(self):
        self.bullets.update()#每次循环都更新子弹编组，组里每一个子弹的update方法都被执行了
        for bullet in self.bullets.copy():  # 遍历编组里的每个子弹
            # 遍历编组复制后的副本，因为python的for循环不允许迭代过程中迭代对象的长度改变，否则会遗漏或重复操作
            if bullet.rect.bottom <= 0:  # 当子弹飞出屏幕外面
                self.bullets.remove(bullet)  # 就把飞出去的子弹从编组里移除出去子弹越来越多影响程序的运行
        # print(len(self.bullets))#检验是否被移除，打印编组的长度


    def _fire_bullet(self):
        """创建一个子弹并将其加入bullets编组里"""
        """限制发射子弹的数量"""
        if len(self.bullets)<self.settings.bullets_allowed:
            new_bullet=Bullet(self)
            self.bullets.add(new_bullet)


if __name__=='__main__':
    #创建游戏实例并运行游戏
    ai=AlienInvasion()
    ai.run_game()
    #如果运行的主程序是当前该文件，新建一个Alien Invasion游戏，并调用run_game方法，即开始游戏的主循环
